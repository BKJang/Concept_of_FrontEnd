# 자바스크립트의 이벤트루프(Event Loop)

## 자바스크립트는 싱글 쓰레드

흔히들 자바스크립트는 싱글쓰레드 기반이라고 얘기한다. 
그게 바로 이벤트루프가 싱글 쓰레드기 때문에 하는 얘기다. 

## 자료구조

스택은 LIFO이며 큐는 FIFO입니다. 
스택은 밑이 비어있는 컵 모양에 넣고 빼는 것이며 큐는 양쪽이 뚫려있는 튜브라고 말한다. 

이 자료구조는 자바스크립트 엔진에서 사용된다. 바로 **호출 '스택'** 과 **태스크 '큐'** 이다.

호출 스택은 어느 언어에서도 존재한다. 쉽게 생각하자면 [main(), a(), b()] 구조로 호출되면 b -> a -> main 순으로 빠져 나가게 된다. 

<br/>

![eventloop](/JavaScript/images/js_eventloop.png)

<br/>

이벤트 루프 설명의 대표적인 예로 `setTimeout()`이 있다.

```javascript
function foo() {
	console.log('b');
}
console.log('a');
setTimeout(foo, 0);
console.log('c');

/*
a
c
b
*/
```

> 1. a를 출력해라
> 2. 0초 뒤에 foo를 실행해라
> 3. c를 출력해라


호출스택에서는 당연히 a -> b -> c 순서로 출력되어야 맞다. 
하지만, **자바스크립트는 호출 스택만 사용하지 않기 때문에** a -> c -> b 순서로 출력된다. 

자바스크립트는 호출스택, 백그라운드, 태스크 큐(es6+부터는 큐 관리방식이 변화되어 태스크 큐 이외도 존재)라는 개념이 존재한다.

> 1. main() 스택에 들어감
> 2. log("a") 도 스택에 들어간 뒤 실행
> 3. setTimeout()이 스택에 들어간 뒤 실행 - 백그라운드에서 0초뒤에 foo를 "실행"시키라고 명령
> 4. 0초가 지나 "태스크큐"에 foo()들어감
> 5. log("c") 가 스택에 들어간 뒤 실행
> 6. main() 종료
> 7. 태스크 큐에 있던 foo()를 호출스택에 밀어넣음 (이벤트 루프가 전역 컨텍스트의 main이 종료되면 큐 실행)
> 8. foo()가 호출스택에 들어간 뒤 실행

## 콜백함수

이런 자바스크립트의 싱글 쓰레드 구조에서 비동기성의 이벤트 기반 실행이나 ajax요청이 필요하다면, **콜백 함수를 이용해 백그라운드로 보내 이를 큐를 통해 호출 스택으로 보내 해결**하게 된다.

자바스크립트에서는 쓰레드를 통해 병렬처리가 안되기 때문에 콜백함수의 사용은 필수다.

## 큐와 콜백

이러한 이벤트 루프의 가장 중요한 점은 바로 위 과정의 3번과 4번 그리고 7번이다. 흔히 setTimeout(foo, 3)이라는 함수를 말할 때 foo 함수를 3초 뒤에 실행시켜라 라고 생각한다. 
그러나 4번에 보듯 **foo는 일정시간 뒤에 실행되는게 아니라 큐에 들어가게 된다.** 

3번에 **백그라운드에서 0초뒤에 foo를 "실행"시키라고 명령**이라고는 적었지만 정확히 말하자면 **foo를 "큐"에 집어넣어라** 가 맞는 것이다. 
큐에 아무것도 없다면 3초뒤에 바로 실행이 되겠지만 만일 다른 콜백으로 인해 다른 작업들이 존재한다면 어떻게 될까?

예상컨대 3초가 넘어가서 실행되게 될 것이다. setTimeout()이라는 함수는 n초 뒤에 콜백을 단순히 큐에 집어넣는게 끝이다. 
이 큐에 들어간 콜백은 **이벤트 루프가 호출 스택으로 밀어넣어 실행**된다. 
코드를 간단히 보자면 아래와 같다.

```javascript
var eventLoop = [];
var event;

while(true) {
    // 틱!
    if (eventLoop.length > 0) {
        event = eventLoop.shift();
    }
    
    try {
        event(); // 호출스택으로 밀어넣는다
    }
    catch(err) {
        //...
    }
}
```

이 큐에 이미 대기번호가 100개가 있다면 foo는 101번째 대기표를 받게 될 것입니다. 따라서 setTimeout()은 **지정한 시간동안은 실행되지 않는 것은 보장할 수 있지만 지정한 시간에 실행되는것은 보장할 수 없다.**
